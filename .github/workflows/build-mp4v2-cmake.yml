name: Build MP4v2 (CMake) for Multiple Platforms

on:
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Platforms to build (comma-separated: linux-arm64, linux-x64, all)'
        required: false
        default: 'linux-arm64'

jobs:
  build-linux-arm64:
    if: contains(github.event.inputs.platforms, 'linux-arm64') || contains(github.event.inputs.platforms, 'all')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64
        
    - name: Build MP4v2 with CMake for ARM64
      run: |
        docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/workspace \
          -w /build \
          arm64v8/ubuntu:22.04 \
          bash -c "
            set -e
            
            # Install dependencies
            export DEBIAN_FRONTEND=noninteractive
            apt-get update
            apt-get install -y \
              build-essential \
              cmake \
              git \
              wget \
              ca-certificates \
              file
            
            # Clone mp4v2
            git clone --depth 1 https://github.com/enzo1982/mp4v2.git
            cd mp4v2
            
            # Build with CMake (shared libraries)
            mkdir -p build && cd build
            cmake .. \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_INSTALL_PREFIX=/build/install \
              -DBUILD_SHARED_LIBS=ON
            make -j\$(nproc)
            make install
            
            # Copy to workspace
            mkdir -p /workspace/Linux/arm64
            
            # Copy shared libraries
            if [ -d /build/install/lib ]; then
              cp -P /build/install/lib/libmp4v2.so* /workspace/Linux/arm64/ 2>/dev/null || true
            fi
            if [ -d /build/install/lib64 ]; then
              cp -P /build/install/lib64/libmp4v2.so* /workspace/Linux/arm64/ 2>/dev/null || true
            fi
            
            # Copy static library if it exists
            if [ -f /build/install/lib/libmp4v2.a ]; then
              cp /build/install/lib/libmp4v2.a /workspace/Linux/arm64/
            fi
            if [ -f /build/install/lib64/libmp4v2.a ]; then
              cp /build/install/lib64/libmp4v2.a /workspace/Linux/arm64/
            fi
            
            # Copy headers
            mkdir -p /workspace/include/mp4v2
            cp -r /build/install/include/mp4v2/* /workspace/include/mp4v2/ 2>/dev/null || true
            
            # Verify architecture
            echo '=== Built libraries ==='
            ls -lh /workspace/Linux/arm64/
            echo ''
            echo '=== Architecture verification ==='
            file /workspace/Linux/arm64/libmp4v2.so* 2>/dev/null || file /workspace/Linux/arm64/libmp4v2.a 2>/dev/null || echo 'No libraries found!'
          "
      
    - name: List build artifacts
      run: |
        echo "=== Linux ARM64 Build Artifacts ==="
        ls -lh Linux/arm64/ || echo "No arm64 artifacts"
        echo ""
        echo "=== Headers ==="
        ls -lh include/mp4v2/ || echo "No headers"
        
    - name: Upload Linux ARM64 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mp4v2-linux-arm64
        path: |
          Linux/arm64/
          include/mp4v2/
        retention-days: 90

  build-linux-x64:
    if: contains(github.event.inputs.platforms, 'linux-x64') || contains(github.event.inputs.platforms, 'all')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake git
        
    - name: Clone and build MP4v2
      run: |
        git clone --depth 1 https://github.com/enzo1982/mp4v2.git /tmp/mp4v2
        cd /tmp/mp4v2
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON -DCMAKE_INSTALL_PREFIX=/tmp/mp4v2/install
        make -j$(nproc)
        make install
        
    - name: Copy artifacts
      run: |
        mkdir -p Linux/x64
        cp -P /tmp/mp4v2/install/lib/libmp4v2.so* Linux/x64/ 2>/dev/null || true
        cp /tmp/mp4v2/install/lib/libmp4v2.a Linux/x64/ 2>/dev/null || true
        mkdir -p include/mp4v2
        cp -r /tmp/mp4v2/install/include/mp4v2/* include/mp4v2/ 2>/dev/null || cp -r /tmp/mp4v2/include/mp4v2/* include/mp4v2/
        
    - name: Upload Linux x64 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mp4v2-linux-x64
        path: |
          Linux/x64/
          include/mp4v2/
        retention-days: 90

